<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Participants enregistrÃ©s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <style>
    .wrap { min-height: 100vh; display: grid; grid-template-rows: 1fr auto; background: var(--sp-bg); }
    .main { max-width: 1100px; margin: 0 auto; padding: 16px; }

    .actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center; margin: 6px 0 10px; }

    .blue { background: var(--sp-primary); color:#fff; border-color: transparent; }
    .red { background: var(--sp-accent-red); color:#fff; border-color: transparent; }
    .green { background: var(--sp-accent-green); color:#fff; border-color: transparent; }
    .yellow { background: var(--sp-accent-yellow); color:#222; border-color: transparent; }
    .purple { background: var(--sp-accent-purple); color:#fff; border-color: transparent; }
    .teal { background: var(--sp-accent-teal); color:#fff; border-color: transparent; }
    .orange { background: var(--sp-accent-orange); color:#222; border-color: transparent; }

    .menu-dropdowns { display:flex; flex-direction:column; gap:10px; margin:16px 0; }
    .menu-group { border:1px solid var(--sp-border); border-radius:14px; padding:10px 14px; background:var(--sp-table-even); box-shadow:var(--sp-card-shadow); }
    .menu-group summary { font-weight:600; cursor:pointer; list-style:none; }
    .menu-group summary::-webkit-details-marker { display:none; }
    .menu-options { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }

    .nav-row { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px; }

    .table-wrapper { background: var(--sp-surface); border-radius: 10px; box-shadow: var(--sp-card-shadow); padding: 12px; overflow-x: auto; }
    table { width:100%; border-collapse: collapse; min-width: 720px; }
    th, td { border: 1px solid var(--sp-border); padding: 8px; text-align: center; }
    thead th { background: var(--sp-sticky-bg); }
    tbody tr.pair { background: var(--sp-table-even); }
    tbody tr.impair { background: var(--sp-table-odd); }

    footer { background: var(--sp-primary); color:#fff; text-align:center; padding:10px 12px; }

    input[type="text"], input[type="number"] {
      padding: 8px 10px;
      border:1px solid var(--sp-border);
      border-radius: 6px;
      min-width: 220px;
      background: var(--sp-surface);
      color: var(--sp-text);
    }

    /* ---- Post-it mÃ©mo (discret) ---- */
    .memo-suppr{
      display:inline-block; margin-top:8px; padding:6px 10px;
      font-size:.95rem; border:1px solid var(--sp-memo-border); background:var(--sp-memo-bg); border-radius:8px;
    }

    /* ---- Bandeau info (donnÃ©es locales) ---- */
    .info-banner{
      margin: 10px auto 12px;
      max-width: 980px;
      border: 1px solid var(--sp-border);
      background: var(--sp-surface);
      color: var(--sp-text);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--sp-card-shadow);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .info-banner p{ margin: 0; line-height: 1.35; }
    .info-banner .info-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .info-banner .small{ opacity: .9; font-size: .95rem; }

    /* ---- Petits ajustements hiÃ©rarchie ---- */
    .section-title{
      text-align:center;
      margin:6px 0 10px;
    }
  </style>

  <script src="theme.js" defer></script>
  <script src="classes-store.js" defer></script>
  <script src="participants.js" defer></script>
</head>

<body>
  <div class="wrap">
    <main class="main">
      <h1 class="section-title">ğŸ‘¥ Participants enregistrÃ©s</h1>

      <!-- Bandeau local-first -->
      <div id="local-banner" class="info-banner" role="note" aria-label="Information de stockage">
        <p>
          <strong>âš ï¸ DonnÃ©es enregistrÃ©es sur cet appareil.</strong>
          <span class="small">Pense Ã  exporter rÃ©guliÃ¨rement (CSV / PDF), surtout sur iPad/Safari.</span>
        </p>
        <div class="info-actions">
          <button type="button" class="button" onclick="exporterCSV()">ğŸ“¥ Export CSV</button>
          <button type="button" class="button" onclick="imprimerTableau()">ğŸ–¨ï¸ PDF</button>
          <button type="button" class="button grey" id="hide-local-banner">ğŸ™ˆ Masquer</button>
        </div>
      </div>

      <!-- Tri -->
      <div class="actions" aria-label="Tri">
        <label for="tri-select">Trier par :</label>
        <select id="tri-select"></select>
        <button class="button blue" type="button" onclick="trierParticipants()">ğŸ”ƒ Appliquer le tri</button>
        <button class="button red" type="button" onclick="resetData()">â™»ï¸ RÃ©initialiser</button>
      </div>

      <!-- Filtre texte -->
      <div class="actions" aria-label="Filtre texte">
        <label for="filtre-txt">Filtrer :</label>
        <input id="filtre-txt" type="text" placeholder="ex. Lola, 5A, F..." oninput="filtrerTexte()">
        <button class="button" type="button" onclick="filtrerTexte()">ğŸ” Rechercher</button>
      </div>

      <!-- Import CSV (input cachÃ©) -->
      <div class="actions" aria-label="Import CSV">
        <input id="csv-input" type="file" accept=".csv" style="display:none" onchange="importerCSV(event)">
      </div>

      <!-- Tableau -->
      <div class="table-wrapper" aria-label="Tableau participants">
        <table id="participants-table">
          <thead id="table-head">
            <tr>
              <th>nom</th><th>prenom</th><th>classe</th><th>sexe</th>
              <th>distance</th><th>vitesse</th><th>vma</th>
            </tr>
          </thead>
          <tbody id="participants-body"></tbody>
        </table>
      </div>

      <!-- Post-it : info appui long -->
      <div class="actions" style="margin-top:8px;">
        <div class="memo-suppr" role="note">ğŸ“ Retirer une ligne : appui long sur la ligne</div>
        <div class="memo-suppr" role="note">âœï¸ Mode Ã©dition actif : toucher un champ pour Ã©crire (bouton violet âœï¸ pour verrouiller / dÃ©verrouiller)</div>
      </div>

      <div class="menu-dropdowns">
        <details class="menu-group" open>
          <summary>âœï¸ Options dâ€™Ã©criture</summary>
          <div class="menu-options">
            <button type="button" class="button" onclick="ajouterColonneManuelle()">â• Ajouter une colonne</button>
            <button type="button" class="button" onclick="supprimerColonneManuelle()">â– Supprimer une colonne</button>
            <button type="button" class="button orange" onclick="ajouterParticipantInline()">â• Ajouter un Ã©lÃ¨ve</button>
            <button id="edit-mode-btn" class="button purple" type="button" onclick="toggleEditMode()">âœï¸ Mode Ã©dition actif</button>
          </div>
        </details>

        <details class="menu-group">
          <summary>ğŸ“ Options dâ€™archivage</summary>
          <div class="menu-options">
            <button type="button" class="button teal" onclick="ouvrirArchivageClasse()">ğŸ’¾ Archiver dans mes classes</button>
            <button type="button" class="button" onclick="exporterCSV()">ğŸ“¥ Exporter CSV</button>
            <button type="button" class="button" onclick="document.getElementById('csv-input').click()">ğŸ“¤ RÃ©importer CSV</button>
            <button type="button" class="button" onclick="imprimerTableau()">ğŸ–¨ï¸ Imprimer / PDF</button>
          </div>
        </details>
      </div>

      <div class="nav-row">
        <a href="index.html" class="button green">ğŸ  Accueil</a>
        <a href="scanner.html" class="button blue">ğŸ“· Scanner des QR Codes</a>
        <a href="classes.html" class="button teal">ğŸ—‚ Classes & sÃ©ances</a>
        <a href="classes.html#new-class-section" class="button yellow">â• CrÃ©er une classe</a>
        <a href="aide.html" class="button purple">â“ Aide</a>
        <a href="groupe-zenos.html" class="button yellow">ğŸ§¬ Groupes ZENOS Tour</a>
      </div>
    </main>

    <footer>
      ScanProf - Ã‰quipe EPS LycÃ©e Vauban - LUXEMBOURG - JB
    </footer>
  </div>

  <!-- Bandeau : mÃ©morise "Masquer" -->
  <script>
    (function () {
      const key = "sp_hide_local_banner";
      const banner = document.getElementById("local-banner");
      const btn = document.getElementById("hide-local-banner");
      if (!banner || !btn) return;

      if (localStorage.getItem(key) === "1") {
        banner.style.display = "none";
        return;
      }
      btn.addEventListener("click", () => {
        localStorage.setItem(key, "1");
        banner.style.display = "none";
      });
    })();
  </script>

  <!-- Migration unique : convertit les clÃ©s MAJ -> minuscules (base fields) -->
  <script>
  (function migrateCaseOnce(){
    if (localStorage.getItem('eleves_case_migrated') === '1') return;

    function load(){ try{ return JSON.parse(localStorage.getItem('eleves'))||[]; }catch{ return []; } }
    function save(x){ localStorage.setItem('eleves', JSON.stringify(x)); }

    const pairs = [
      ['Nom','nom'],['PrÃ©nom','prenom'],['Prenom','prenom'],
      ['Classe','classe'],['Sexe','sexe'],
      ['Distance','distance'],['Vitesse','vitesse'],['VMA','vma']
    ];

    let arr = load(), changed = false;
    arr.forEach(e=>{
      if(!e) return;
      pairs.forEach(([from,to])=>{
        if (e[from] !== undefined) {
          if (e[to] === undefined) e[to] = e[from];
          delete e[from];
          changed = true;
        }
      });
    });
    if (changed) save(arr);

    localStorage.setItem('eleves_case_migrated','1');
    if (changed) location.reload();
  })();
  </script>
</body>
</html>
